<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Newhouse Point</title>
  <meta name="description" content="Engage your brain without distractions.">
  <style>
    :root{
      --bg:#0b0f14; --card:#111826; --text:#e7eefc; --muted:#9fb0cc;
      --line:#22324a; --btn:#1a2638; --btn2:#182234; --ok:#1f7a4a;
      --warn:#7a5a1f; --bad:#7a1f2a;
      --radius:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{ margin:0; background:linear-gradient(180deg,#0b0f14,#0a1220); color:var(--text); }
    .wrap{ max-width:900px; margin:0 auto; padding:24px; }
    h1{ font-size:22px; margin:0 0 6px; }
    p{ margin:0 0 14px; color:var(--muted); line-height:1.4; }
    .grid{ display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 800px){ .grid{ grid-template-columns: 1.2fr 0.8fr; } }
    .card{
      background:rgba(17,24,38,.9);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button, input, select, textarea{
      background:var(--btn);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    button{ cursor:pointer; }
    button:hover{ filter:brightness(1.08); }
    button:active{ transform:translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .primary{ background:linear-gradient(180deg,#1a2d46,#16253a); }
    .stop{ background:linear-gradient(180deg,#3a1a22,#2a1218); border-color:#5a1f2a; }
    .pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi .box{ flex:1; min-width:160px; background:rgba(0,0,0,.12); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .big{ font-size:20px; font-weight:700; margin-top:4px; }
    .small{ font-size:12px; color:var(--muted); }
    textarea{ width:100%; min-height:130px; resize:vertical; background:var(--btn2); }
    .activity-title{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .hint{ font-size:12px; color:var(--muted); }
    .divider{ height:1px; background:var(--line); margin:12px 0; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .hidden{ display:none !important; }
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.72);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      max-width:520px; width:100%;
      background:var(--card); border:1px solid var(--line);
      border-radius:18px; padding:18px;
    }
    .modal h2{ margin:0 0 8px; font-size:18px; }
    ul{ margin:10px 0 0 18px; color:var(--muted); }
    a{ color:#a8c8ff; }
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
  </style>
  <script src="https://newhs.cc/words.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h1>Newhouse Point</h1>
          <p>Do small, wonderful things with Newhouse Point.</p>
        </div>
        <span class="pill" id="modePill">Mode: calm</span>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="small">Time left in this session</div>
          <div class="big mono" id="timeLeft">00:00</div>
        </div>
        <div class="box">
          <div class="small">Your stop rule</div>
          <div class="big" id="stopRule">Stop when timer ends</div>
        </div>
        <div class="box">
          <div class="small">Current activity</div>
          <div class="big" id="activityName">Pick one</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <label class="hint">Session length</label>
        <select id="sessionMins">
          <option value="1">1 min</option>
          <option value="2">2 min</option>
          <option value="3">3 min</option>
          <option value="5" selected>5 min</option>
          <option value="10">10 min</option>
          <option value="15">15 min</option>
        </select>

        <label class="hint">Stop rule</label>
        <select id="stopRuleSel">
          <option value="timer" selected>Stop when timer ends</option>
          <option value="oneTask">Stop after 1 activity</option>
          <option value="twoTasks">Stop after 2 activities</option>
          <option value="threeTasks">Stop after 3 activities</option>
        </select>

        <button class="primary" id="startBtn">Start</button>
        <button id="pauseBtn">Pause</button>
        <button class="stop" id="stopBtn">Stop now</button>

        <span class="pill" id="statusPill">Ready</span>
      </div>
    </div>

    <div class="grid" style="margin-top:14px;">
      <div class="card">
        <div class="activity-title">
          <h2 style="margin:0;font-size:16px;">Activities</h2>
          <span class="pill"><span id="doneCount">0</span>/<span id="limitCount">‚àû</span> done</span>
        </div>
        <p class="hint">Pick one. The goal is to pass time gently.</p>

        <div id="activityButtons" class="row" style="margin-top:8px;">
          <button data-act="breath">Box breathing (2 min)</button>
          <button data-act="write">Boredom journal (3 min)</button>
          <button data-act="logic">Tiny logic (3 min)</button>
          <button data-act="tidy">Micro tidy (2 min)</button>
          <button data-act="plan">One-step plan (1 min)</button>
          <button data-act="jamalese">Jamalese (3 min)</button>
        </div>

        <div class="divider"></div>

        <div id="panel_breath" class="panel hidden">
          <p><b>Box breathing:</b> inhale 4 ‚Üí hold 4 ‚Üí exhale 4 ‚Üí hold 4. Repeat calmly.</p>
          <div class="row">
            <button id="breathStart" class="primary">Start 2-minute guide</button>
            <span class="pill mono" id="breathPhase">idle</span>
            <span class="pill mono" id="breathTimer">02:00</span>
          </div>
          <p class="hint" id="breathHint">Tip: keep shoulders relaxed, breathe quietly.</p>
        </div>

        <div id="panel_write" class="panel hidden">
          <p><b>Boredom journal:</b> write on and on.</p>
          <textarea id="journal" placeholder="What am I avoiding? What would make the next few minutes slightly better? One kind thing I can do for future-me? Write down anything..."></textarea>
          <div class="row">
            <button id="saveJournal">Save locally</button>
            <button id="loadJournal">Load</button>
            <span class="pill" id="journalStatus">Not saved</span>
          </div>
        </div>

        <div id="panel_logic" class="panel hidden">
          <p><b>Tiny logic:</b> answer slowly. No scoring.</p>
          <p id="logicQ" class="mono" style="margin-top:10px;"></p>
          <div class="row">
            <input id="logicA" placeholder="your answer" style="flex:1; min-width:220px;" />
            <button id="logicReveal">Reveal explanation</button>
          </div>
          <div id="logicExplain" class="hint" style="margin-top:10px;"></div>
          <div class="row" style="margin-top:10px;">
            <button id="logicNext">Another one</button>
          </div>
        </div>

        <div id="panel_tidy" class="panel hidden">
          <p><b>Micro tidy:</b> choose one tiny area and reset it.</p>
          <div class="row">
            <button class="primary" id="tidyPick">Give me an area</button>
            <span class="pill" id="tidyArea">‚Äî</span>
          </div>
          <div class="divider"></div>
          <p class="hint">Come back when done.</p>
        </div>

        <div id="panel_plan" class="panel hidden">
          <p><b>One-step plan:</b> pick one thing you‚Äôll do after this session ends.</p>
          <div class="row">
            <input id="planInput" placeholder="Example: do homework or something" style="flex:1; min-width:220px;" />
            <button id="planSave">Save</button>
          </div>
          <p class="hint">Keep it small. The point is to transition out of boredom.</p>
          <div class="pill" id="planOut" style="margin-top:10px;">Saved plan: ‚Äî</div>
        </div>

        <div id="panel_jamalese" class="panel hidden">
          <p><b>üåç Jamalese Corner</b></p>

          <p>
            <b>Word of the Day:</b>
            <span id="wotdWord">‚Äî</span> ‚Äî
            <span id="wotdMeaning">‚Äî</span>
          </p>

          <div class="divider"></div>

          <p><b>Guess this Jamalese word:</b></p>
          <h3 id="guessWord">‚Äî</h3>

          <div id="guessChoices" class="row"></div>

          <p class="hint" id="guessResult"></p>
          <p class="hint">Guesses this session: <span id="jamCount">0</span>/10</p>

          <button id="nextJamalese">Generate question</button>
        </div>

        <!-- SHIFT PANEL -->
        <div id="panel_shift" class="panel hidden">
          <h2>‚áß Shift Mode</h2>
          <p class="hint">A short guided mode to shift your brain out of cravings and into action.</p>

          <button id="startShiftBtn" class="primary">Start Shift Mode</button>

          <div id="shiftQuestion" class="hidden">
            <p class="hint">Are you able to move right now?</p>
            <button id="shiftMoveYes">I can move</button>
            <button id="shiftMoveNo">I must stay still</button>
          </div>

          <div id="shiftTaskBox" class="hidden">
            <p class="big" id="shiftTaskText">‚Äî</p>

            <textarea id="shiftInput" class="hidden" placeholder="Type here..."></textarea>

            <div class="row">
              <button id="shiftDoneBtn">Done</button>
              <button id="shiftNextPhysicalBtn" class="hidden">Another physical</button>
              <button id="shiftGoNextBtn" class="hidden">Go next</button>
            </div>

            <p class="hint mono" id="shiftTimerText">00:00</p>
          </div>
        </div>

      </div>

      <div class="card">
        <h2 style="margin:0;font-size:16px;">Infobar</h2>
        <p class="hint">
          This page intentionally avoids: random rewards, infinite feeds, streaks, flashy animations, points. Pass the time without dopamine.
        </p>

        <div class="divider"></div>
        <button id="toggleShift">Shift</button>
        <button id="toggleCalm">Calm</button>
        <button id="toggleUltra">Minimal</button>
        <div class="divider"></div>

        <h3 style="margin:0 0 8px;font-size:14px;">Saved notes</h3>
        <p class="hint mono" id="savedPreview">‚Äî</p>
        <p class="hint mono" id="savedJour">‚Äî</p>

        <div class="divider"></div>
        <p class="hint">
          What does ‚Äúbored‚Äù usually means for you? (tired? anxious? procrastinating?)
        </p>
        <div class="divider"></div>
        <p class="hint">Have you eaten your musket?</p>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>Session ended. Stop here.</h2>
      <p class="hint">
        Don‚Äôt start another one immediately. Stand up, drink water, or do your saved plan.
      </p>
      <ul>
        <li>AI Tips: If you still feel bored, switch environments, rooms, tasks.</li>
        <li>If you‚Äôre tired, sleep is recommended.</li>
      </ul>
      <div class="row" style="margin-top:14px;">
        <button id="closeOverlay" class="stop">Close</button>
      </div>
    </div>
  </div>

  <div id="startPopup" class="overlay hidden">
    <div class="modal">
      <h2>üåø Start a session first</h2>
      <p class="hint">Choose a time length and press start first to do a task.</p>
      <div class="row" style="margin-top:14px;">
        <button id="closeStartPopup" class="stop">Close</button>
      </div>
    </div>
  </div>

  <p id="safety" style="margin-left: 60px; margin-top:0; margin-bottom:5px;">Click for Minimal ‚Üí Calm</p>
  <p style="margin-left: 60px; margin-top:0; margin-bottom:30px" class="hint">¬© 2026 Made by Newhouse Labs</p>

  <script>
    // --------- Small helpers ----------
    const $ = (id) => document.getElementById(id);

    function fmt(ms){
      ms = Math.max(0, ms);
      const total = Math.floor(ms/1000);
      const m = String(Math.floor(total/60)).padStart(2,"0");
      const s = String(total%60).padStart(2,"0");
      return `${m}:${s}`;
    }
    function setStatus(text){ $("statusPill").textContent = text; }
    function setModePill(text){ $("modePill").textContent = `Mode: ${text}`; }

    // Preserve Calm session options so Shift can temporarily replace them
    const calmSessionOptionsHTML = $("sessionMins").innerHTML;

    // --------- Calm state ----------
    let running = false;
    let remainingMs = 10 * 60 * 1000;
    let tick = null;

    let stopMode = "timer";
    let taskLimit = Infinity;
    let tasksDone = 0;

    let currentAct = null;

    // Breath guide
    let breathTick = null;
    let breathRemaining = 2 * 60;
    let breathPhase = "idle";

    // --------- Jamalese ----------
    let jamCount = 0;
    const JAM_MAX = 10;
    let wotdIndex = null;
    let currentGuessWord = null;

    // --------- Shift Mode state ----------
    let mode = "calm"; // calm | shift

    let shiftRunning = false;
    let shiftPhase = 0; // 1 physical, 2 creative, 3 trivia
    let shiftStartTime = 0;
    let shiftCanMove = false;
    let shiftDurationSec = 4 * 60; // 4/8/10 min based on session select in shift
    let shiftTimerTick = null; // timeout loop

    // Typed tasks (so we can show textbox when needed)
    const shiftPhysicalPool = [
      { type:"physical", text:"Do 10 squats" },
      { type:"physical", text:"Stretch your arms for 30 seconds" },
      { type:"physical", text:"Drink a glass of water" },
      { type:"physical", text:"Walk to another room" },
      { type:"physical", text:"Roll your shoulders slowly (10 rolls)" }
    ];
    const shiftCreativePool = [
      { type:"write",  text:"Write one Jamalese sentence" },
      { type:"write",  text:"Write 3 ideas (any topic)" },
      { type:"write",  text:"Describe something you see (2 sentences)" },
      { type:"write",  text:"Invent a new word and its meaning" },
      { type:"draw",   text:"Draw something simple (on paper)" }
    ];
    const shiftTriviaPool = [
      { type:"answer", text:"Solve: 7 √ó 8" },
      { type:"answer", text:"What day is 3 days after Friday?" },
      { type:"answer", text:"What is 9 + 6 √ó 2?" },
      { type:"answer", text:"Name 3 countries in Asia" }
    ];

    // --------- Logic bank ----------
    const logicBank = [
      { q:"If today is Wednesday, what day is 10 days from today?", a:"Saturday", e:"10 ‚â° 3 (mod 7). Wednesday + 3 days = Saturday." },
      { q:"You have 3 switches outside a room; one controls a lamp inside. You may enter the room once. How do you know which switch?",
        a:"Use heat: turn one on for a while, off; turn another on; enter. On=second, warm=first, cold=third.",
        e:"Classic reasoning puzzle: light + warmth give two bits of info." },
      { q:"What‚Äôs the next number: 1, 2, 3, 5, 8, 13, ?", a:"21", e:"Each term is the sum of the previous two." },
      { q:"If A implies B, and B is false, what can you say about A?", a:"A must be false.", e:"Contrapositive: A‚ÜíB means ¬¨B‚Üí¬¨A." },
      { q:"Rearrange: 'LISTEN' to make a word meaning 'quiet'.", a:"SILENT", e:"Anagram. Just notice it." }
    ];
    let logicIdx = 0;

    const tidyAreas = [
      "clear 10 items on your desk",
      "throw away 3 pieces of trash",
      "refill your water bottle",
      "put 5 things back where they belong",
      "wipe your screen / keyboard quickly",
      "make a reminder / todo list"
    ];

    // --------- UI helpers ----------
    function updateCounters(){
      $("doneCount").textContent = tasksDone;
      $("limitCount").textContent = (taskLimit === Infinity) ? "‚àû" : taskLimit;
    }
    function updateStopRuleLabel(){
      const map = {
        timer: "Stop when timer ends",
        oneTask: "Stop after 1 activity",
        twoTasks: "Stop after 2 activities",
        threeTasks: "Stop after 3 activities"
      };
      $("stopRule").textContent = map[stopMode];
    }
    function showPanel(name){
      for (const el of document.querySelectorAll(".panel")) el.classList.add("hidden");
      $("panel_"+name).classList.remove("hidden");
      currentAct = name;
      $("activityName").textContent = ({
        breath:"Box breathing",
        write:"Boredom journal",
        logic:"Tiny logic",
        tidy:"Micro tidy",
        plan:"One-step plan",
        jamalese:"Jamalese exercise",
        shift:"Shift Mode"
      })[name] || "Pick one";
    }

    // --------- Session end / stop ----------
    function stopShiftInternal(){
      shiftRunning = false;
      if (shiftTimerTick) { clearTimeout(shiftTimerTick); shiftTimerTick = null; }
      $("shiftQuestion").classList.add("hidden");
      $("shiftTaskBox").classList.add("hidden");
      $("shiftInput").classList.add("hidden");
      $("shiftInput").value = "";
      $("shiftNextPhysicalBtn").classList.add("hidden");
      $("shiftGoNextBtn").classList.add("hidden");
      $("shiftTimerText").textContent = "00:00";
    }

    function stopEverything(){
      // calm timer
      running = false;
      clearInterval(tick); tick = null;
      setStatus("Stopped");
      $("pauseBtn").textContent = "Pause";

      // breath
      clearInterval(breathTick); breathTick=null;
      breathPhase="idle"; $("breathPhase").textContent = "idle";
      breathRemaining = 2*60; $("breathTimer").textContent = "02:00";

      // shift
      stopShiftInternal();

      // reset counters (your original behavior)
      tasksDone = 0;
      updateCounters();
    }

    function endSession(){
      stopEverything();
      $("overlay").classList.remove("hidden");
      $("timeLeft").textContent="00:00";
      $("activityName").textContent = "Session ended";
    }

    // --------- Calm session logic ----------
    function applyStopMode(){
      stopMode = $("stopRuleSel").value;
      taskLimit = Infinity;
      if (stopMode === "oneTask") taskLimit = 1;
      if (stopMode === "twoTask") taskLimit = 2;
      if (stopMode === "twoTasks") taskLimit = 2;
      if (stopMode === "threeTasks") taskLimit = 3;
      updateStopRuleLabel();
      updateCounters();
    }

    function startSession(){
      const mins = Number($("sessionMins").value);
      remainingMs = mins * 60 * 1000;
      $("timeLeft").textContent = fmt(remainingMs);

      tasksDone = 0;
      applyStopMode();
      updateCounters();

      // reset Jamalese session counter
      jamCount = 0;
      $("jamCount").textContent = "0";
      loadJamaleseGuess();

      running = true;
      setStatus("Running");
      clearInterval(tick);
      tick = setInterval(()=>{
        remainingMs -= 1000;
        $("timeLeft").textContent = fmt(remainingMs);
        if (remainingMs <= 0){
          endSession();
        }
      }, 1000);
    }

    function togglePause(){
      if (!running) return;
      if (tick){
        clearInterval(tick); tick = null;
        setStatus("Paused");
        $("pauseBtn").textContent = "Resume";
      } else {
        setStatus("Running");
        $("pauseBtn").textContent = "Pause";
        tick = setInterval(()=>{
          remainingMs -= 1000;
          $("timeLeft").textContent = fmt(remainingMs);
          if (remainingMs <= 0){
            endSession();
          }
        }, 1000);
      }
    }

    function countTaskDone(){
      tasksDone += 1;
      updateCounters();
      if (tasksDone >= taskLimit){
        endSession();
      }
    }

    // --------- Breath ----------
    function startBreathGuide(){
      clearInterval(breathTick);
      breathRemaining = 2*60;
      const phases = [["inhale",4],["hold",4],["exhale",4],["hold",4]];
      let p = 0, t = phases[0][1];
      breathPhase = phases[0][0];
      $("breathPhase").textContent = breathPhase;

      breathTick = setInterval(()=>{
        breathRemaining--;
        $("breathTimer").textContent = fmt(breathRemaining*1000);

        t--;
        if (t <= 0){
          p = (p+1) % phases.length;
          breathPhase = phases[p][0];
          t = phases[p][1];
          $("breathPhase").textContent = breathPhase;
        }
        if (breathRemaining <= 0){
          clearInterval(breathTick); breathTick=null;
          $("breathPhase").textContent = "done";
          countTaskDone();
        }
      }, 1000);
    }

    // --------- Logic ----------
    function loadLogic(){
      const item = logicBank[logicIdx % logicBank.length];
      $("logicQ").textContent = item.q;
      $("logicA").value = "";
      $("logicExplain").textContent = "";
    }
    function revealLogic(){
      const item = logicBank[logicIdx % logicBank.length];
      $("logicExplain").textContent = `Expected: ${item.a}. Why: ${item.e}`;
      countTaskDone();
    }

    // --------- Journal ----------
    function saveJournal(){
      if (localStorage.getItem("calmKit_journal") != $("journal").value.trim()) {
        localStorage.setItem("calmKit_journal", $("journal").value);
        $("journalStatus").textContent = "Saved";
        refreshSavedPreview();
        countTaskDone();
      }
    }
    function loadJournal(){
      $("journal").value = localStorage.getItem("calmKit_journal") || "";
      $("journalStatus").textContent = "Loaded";
      refreshSavedPreview();
    }

    // --------- Plan ----------
    function savePlan(){
      if (localStorage.getItem("calmKit_plan") != $("planInput").value.trim()) {
        const v = $("planInput").value.trim();
        if (!v) return;
        localStorage.setItem("calmKit_plan", v);
        $("planOut").textContent = "Saved plan: " + v;
        refreshSavedPreview();
        countTaskDone();
      }
    }

    function refreshSavedPreview(){
      const j = (localStorage.getItem("calmKit_journal") || "").trim();
      const p = (localStorage.getItem("calmKit_plan") || "").trim();
      let out = "";
      let jot = "";
      if (p) out = "Plan: " + p;
      if (j) jot = "Journal: " + (j.length>120 ? j.slice(0,120)+"‚Ä¶" : j);
      $("savedPreview").textContent = out || "‚Äî";
      $("savedJour").textContent = jot || "‚Äî";
    }

    // --------- Tidy ----------
    function pickTidy(){
      const idx = Math.floor(Math.random()*tidyAreas.length);
      $("tidyArea").textContent = tidyAreas[idx];
    }

    // --------- Minimal (Ultra) ----------
    function setUltra(on){
      if (on){
        setModePill("ultra-minimal");
        document.querySelectorAll(".grid .card:nth-child(2), .kpi .box:nth-child(2), .kpi .box:nth-child(3)")
          .forEach(el => el.classList.add("hidden"));
        document.querySelectorAll(".row").forEach((el,i)=>{
          if (i > 0) el.classList.add("hidden");
        });
        $("toggleCalm").classList.remove("hidden");
      } else {
        // don't let calm button accidentally exit shift; calm button only resets ultra/minimal in calm mode
        if (mode === "shift") return;

        setModePill("calm");
        document.querySelectorAll(".grid .card:nth-child(2), .kpi .box:nth-child(2), .kpi .box:nth-child(3)")
          .forEach(el => el.classList.remove("hidden"));
        document.querySelectorAll(".row").forEach(el=> el.classList.remove("hidden"));
        for (const el of document.querySelectorAll(".panel")) el.classList.add("hidden");
        if (currentAct) $("panel_"+currentAct).classList.remove("hidden");
      }
    }

    // --------- Start-session popup ----------
    function showStartSessionPopup(){
      $("startPopup").classList.remove("hidden");
    }
    $("closeStartPopup").addEventListener("click", ()=>{
      $("startPopup").classList.add("hidden");
    });

    // --------- Jamalese ----------
    function loadWordOfTheDay(){
      wotdIndex = Math.floor(Math.random() * dictionary.length);
      const w = dictionary[wotdIndex];
      $("wotdWord").textContent = w[0];
      $("wotdMeaning").textContent = w[1];
    }

    function disableGuessButtons(){
      document.querySelectorAll("#guessChoices button").forEach(b => b.disabled = true);
    }

    function loadJamaleseGuess(){
      if (jamCount >= JAM_MAX){
        $("guessWord").textContent = "Enough Jamalese for now üåø";
        $("guessChoices").innerHTML = "";
        $("guessResult").textContent = "Try another calm activity.";
        return;
      }

      let idx;
      do {
        idx = Math.floor(Math.random() * dictionary.length);
      } while (idx === wotdIndex);

      currentGuessWord = dictionary[idx];

      $("guessWord").textContent = currentGuessWord[0];
      $("guessResult").textContent = "";

      let choices = [currentGuessWord[1]];
      while (choices.length < 4){
        const m = dictionary[Math.floor(Math.random()*dictionary.length)][1];
        if (!choices.includes(m)) choices.push(m);
      }
      choices.sort(() => Math.random() - 0.5);

      const box = $("guessChoices");
      box.innerHTML = "";

      choices.forEach(choice=>{
        const btn = document.createElement("button");
        btn.textContent = choice;
        btn.onclick = ()=>{
          $("guessResult").textContent = "It means: " + currentGuessWord[1];
          jamCount++;
          $("jamCount").textContent = jamCount;
          disableGuessButtons();
          if (jamCount >= JAM_MAX) countTaskDone();
        };
        box.appendChild(btn);
      });
    }

    // --------- SHIFT MODE (correct logic) ----------
    function enterShiftMode(){
      mode = "shift";
      setModePill("shift");

      // hide calm activity buttons
      $("activityButtons").classList.add("hidden");

      // show shift panel
      showPanel("shift");

      // disable stop rules in shift
      $("stopRuleSel").disabled = true;

      // force session mins to 4/8/10 in shift
      $("sessionMins").innerHTML = `
        <option value="4" selected>4 min</option>
        <option value="8">8 min</option>
        <option value="10">10 min</option>
      `;

      // reset shift UI
      stopShiftInternal();
      $("startShiftBtn").classList.remove("hidden");
$("toggleUltra").disabled = true;
    }

    function exitShiftMode(){
      // Return to calm
      mode = "calm";
      setModePill("calm");

      $("activityButtons").classList.remove("hidden");
      $("stopRuleSel").disabled = false;

      // restore calm session options
      $("sessionMins").innerHTML = calmSessionOptionsHTML;

      stopShiftInternal();
      showPanel("logic"); // or hide all panels; logic is just a safe default
      for (const el of document.querySelectorAll(".panel")) el.classList.add("hidden");
      $("activityName").textContent = "Pick one";
$("toggleUltra").disabled = false;
    }

    function shiftPick(pool){
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function shiftShowTask(task, physicalChoiceButtons){
      $("shiftTaskText").textContent = task.text;

      // textbox rules
      if (task.type === "write" || task.type === "answer"){
        $("shiftInput").classList.remove("hidden");
        $("shiftInput").value = "";
        $("shiftInput").focus();
      } else {
        $("shiftInput").classList.add("hidden");
        $("shiftInput").value = "";
      }

      // physical choice buttons
      if (physicalChoiceButtons){
        $("shiftNextPhysicalBtn").classList.remove("hidden");
        $("shiftGoNextBtn").classList.remove("hidden");
      } else {
        $("shiftNextPhysicalBtn").classList.add("hidden");
        $("shiftGoNextBtn").classList.add("hidden");
      }
    }

    function shiftUpdateTimer(){
      const elapsed = Math.floor((Date.now() - shiftStartTime)/1000);
      const left = shiftDurationSec - elapsed;
      $("shiftTimerText").textContent = fmt(left*1000);

      if (left <= 0){
        // end shift -> end session overlay
        shiftRunning = false;
        endSession();
        return;
      }
      if (shiftRunning){
        shiftTimerTick = setTimeout(shiftUpdateTimer, 1000);
      }
    }

    function shiftNextTask(){
      const elapsed = Math.floor((Date.now() - shiftStartTime)/1000);

      // Phase rules:
      // If phase 1 (physical), tasks are controlled by buttons (another/go next).
      // Phase 2 until 2:00 elapsed, then phase 3 for rest of time.
      if (shiftPhase === 1){
        shiftShowTask(shiftPick(shiftPhysicalPool), true);
        return;
      }

      if (elapsed < 120){
        shiftPhase = 2;
        shiftShowTask(shiftPick(shiftCreativePool), false);
      } else {
        shiftPhase = 3;
        shiftShowTask(shiftPick(shiftTriviaPool), false);
      }
    }

    function startShiftRun(){
      // shift duration based on sessionMins (4/8/10)
      const mins = Number($("sessionMins").value);
      shiftDurationSec = mins * 60;

      shiftRunning = true;
      shiftStartTime = Date.now();

      // decide starting phase
      shiftPhase = shiftCanMove ? 1 : 2;

      $("startShiftBtn").classList.add("hidden");
      $("shiftQuestion").classList.add("hidden");
      $("shiftTaskBox").classList.remove("hidden");

      shiftNextTask();
      // timer loop
      if (shiftTimerTick) clearTimeout(shiftTimerTick);
      shiftUpdateTimer();
    }

    // Shift UI wiring
    $("startShiftBtn").addEventListener("click", ()=>{
      $("shiftQuestion").classList.remove("hidden");
    });
    $("shiftMoveYes").addEventListener("click", ()=>{
      shiftCanMove = true;
      startShiftRun();
    });
    $("shiftMoveNo").addEventListener("click", ()=>{
      shiftCanMove = false;
      startShiftRun();
    });

    // Done button:
    // - In phase 1, Done just finishes that physical and asks choice (buttons already visible).
    // - In phases 2/3, Done gets next task.
    $("shiftDoneBtn").addEventListener("click", ()=>{
      if (!shiftRunning) return;

      if (shiftPhase === 1){
        // after ONE physical, user chooses: another physical or go next
        // we keep the same choice buttons visible; just update instruction slightly
        $("shiftTaskText").textContent = "Physical done. Choose:";
        $("shiftInput").classList.add("hidden");
        $("shiftInput").value = "";
        $("shiftNextPhysicalBtn").classList.remove("hidden");
        $("shiftGoNextBtn").classList.remove("hidden");
        return;
      }

      // phase 2 or 3:
      shiftNextTask();
    });

    $("shiftNextPhysicalBtn").addEventListener("click", ()=>{
      if (!shiftRunning) return;
      // stay in phase 1, show another physical task
      shiftPhase = 1;
      shiftNextTask();
    });

    $("shiftGoNextBtn").addEventListener("click", ()=>{
      if (!shiftRunning) return;
      // move to creative pool
      shiftPhase = 2;
      $("shiftNextPhysicalBtn").classList.add("hidden");
      $("shiftGoNextBtn").classList.add("hidden");
      shiftNextTask();
    });

    // --------- Wiring (buttons) ----------
    $("startBtn").addEventListener("click", startSession);
    $("pauseBtn").addEventListener("click", togglePause);
    $("stopBtn").addEventListener("click", endSession);
    $("stopRuleSel").addEventListener("change", applyStopMode);

    // Only allow calm activities if a calm session is running AND not shift mode
    document.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if (mode === "shift"){
          // in shift mode, calm buttons are hidden anyway; but just in case
          return;
        }
        if (!running){
          showStartSessionPopup();
          return;
        }
        const act = btn.dataset.act;
        showPanel(act);
      });
    });

    $("breathStart").addEventListener("click", startBreathGuide);
    $("logicReveal").addEventListener("click", revealLogic);
    $("logicNext").addEventListener("click", ()=>{ logicIdx++; loadLogic(); });

    $("saveJournal").addEventListener("click", saveJournal);
    $("loadJournal").addEventListener("click", loadJournal);
    $("planSave").addEventListener("click", savePlan);
    $("tidyPick").addEventListener("click", pickTidy);

    $("toggleShift").addEventListener("click", enterShiftMode);

    // Calm button here is meant for minimal->calm, but also can exit shift
    $("toggleCalm").addEventListener("click", ()=>{
      if (mode === "shift"){
        exitShiftMode();
      } else {
        setUltra(false);
      }
    });
    $("safety").addEventListener("click", ()=> setUltra(false));
    $("toggleUltra").addEventListener("click", ()=> setUltra(true));

    $("nextJamalese").addEventListener("click", loadJamaleseGuess);

    $("closeOverlay").addEventListener("click", ()=>{
      $("overlay").classList.add("hidden");
    });

    // init
    applyStopMode();
    updateStopRuleLabel();
    updateCounters();
    refreshSavedPreview();
    loadLogic();
    loadWordOfTheDay();
  </script>
</body>
</html>
